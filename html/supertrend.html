<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Advanced cryptocurrency trading bot with AI-powered insights" />
  <title>Pyrmethus's Neon Bybit Bot Grimoire</title>

  <!-- Tailwind v3 CDN with plugins -->
  <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
  <script>
    tailwind.config = {
      safelist: [
        { pattern: /^(bg|text|border|glow|from|to|via)-(red|green|blue|purple|pink|cyan|yellow|fuchsia|slate|indigo|lime|teal|emerald|orange|violet)-(300|400|500|600|700)$/ },
        { pattern: /^animate-(pulse|spin|bounce|ping)$/ }
      ]
    }
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ---------- CSS Variables ---------- */
    :root {
      --c-bg-dark: #020617; --c-text-dark: #E2E8F0;
      --c-bg-light: #F8FAFC; --c-text-light: #1E293B;
      --c-bg-900: #0F172A; --c-bg-800: #1E293B; --c-bg-700: #334155;
      --c-slate-200: #E2E8F0; --c-slate-400: #94A3B8; --c-slate-600: #475569;
      --c-purple: #A855F7; --c-pink: #EC4899; --c-green: #10B981; --c-cyan: #06B6D4;
      --c-red: #EF4444; --c-yellow: #F59E0B; --c-blue: #3B82F6;
    }

    /* Base styles */
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: var(--c-bg-dark); 
      color: var(--c-text-dark);
      transition: all 0.3s ease;
      position: relative;
      min-height: 100vh;
    }
    
    /* Light theme */
    [data-theme="light"] body { background: var(--c-bg-light); color: var(--c-text-light); }
    [data-theme="light"] .dark\:bg-slate-800 { background: #F3F4F6; }
    [data-theme="light"] .dark\:bg-slate-900 { background: #FFFFFF; }
    [data-theme="light"] .dark\:border-slate-700 { border-color: #E5E7EB; }
    [data-theme="light"] .input-field { background: #F9FAFB; color: #1F2937; border-color: #D1D5DB; }

    /* Animated background */
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(1deg); }
    }
    
    .bg-particles {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(168, 85, 247, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
      animation: float 30s ease-in-out infinite;
    }

    /* Neon effects */
    .neon-text-glow { 
      text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    /* Glow utilities */
    .glow-purple { box-shadow: 0 0 10px var(--c-purple), 0 0 20px var(--c-purple); }
    .glow-pink { box-shadow: 0 0 10px var(--c-pink), 0 0 20px var(--c-pink); }
    .glow-green { box-shadow: 0 0 10px var(--c-green), 0 0 20px var(--c-green); }
    .glow-red { box-shadow: 0 0 10px var(--c-red), 0 0 20px var(--c-red); }

    /* Enhanced buttons */
    .btn {
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 0; height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.6s;
    }
    .btn:active::before {
      width: 300px; height: 300px;
    }

    /* Input styles */
    .input-field {
      background: var(--c-bg-700);
      color: var(--c-text-dark);
      border: 1px solid var(--c-slate-600);
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: all 0.2s;
      width: 100%;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--c-purple);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--c-bg-900); }
    ::-webkit-scrollbar-thumb { 
      background: var(--c-slate-600); 
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover { background: var(--c-slate-400); }

    /* Log area */
    .scrollable-log {
      max-height: 400px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    /* Log entries */
    .log-entry {
      padding: 4px 12px;
      margin: 2px 0;
      border-left: 3px solid transparent;
      border-radius: 0 4px 4px 0;
      font-variant-numeric: tabular-nums;
      transition: all 0.2s;
      font-size: 0.875rem;
      position: relative;
    }
    .log-entry:hover { 
      background: rgba(255, 255, 255, 0.05); 
      transform: translateX(2px);
    }
    .log-entry.success { border-left-color: #10B981; color: #86EFAC; }
    .log-entry.info { border-left-color: #06B6D4; color: #67E8F9; }
    .log-entry.warning { border-left-color: #F59E0B; color: #FACC15; }
    .log-entry.error { border-left-color: #EF4444; color: #F87171; }
    .log-entry.signal { border-left-color: #EC4899; color: #EC4899; }
    .log-entry.llm { border-left-color: #A855F7; color: #A855F7; }

    /* Spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--c-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    /* Metric cards */
    .metric-card {
      background: var(--c-bg-900);
      border: 2px solid var(--c-slate-600);
      border-radius: 0.75rem;
      padding: 1rem;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .metric-card::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(45deg, transparent, var(--glow-color, var(--c-purple)), transparent);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: -1;
      border-radius: 0.75rem;
    }
    .metric-card:hover::before { opacity: 0.2; }
    .metric-card:hover { transform: translateY(-2px); }

    /* Connection status */
    .connection-status {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.75rem;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
      z-index: 100;
    }
    .connection-status.connected {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10B981;
    }
    .connection-status.polling {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #F59E0B;
    }
    .connection-status.disconnected {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #EF4444;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--c-bg-800);
      color: var(--c-text-dark);
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      transform: translateX(400px);
      transition: transform 0.3s;
      z-index: 1000;
      max-width: 320px;
      border: 1px solid var(--c-slate-600);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { border-color: #10B981; }
    .toast.error { border-color: #EF4444; }
    .toast.warning { border-color: #F59E0B; }

    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 1rem;
    }

    /* Keyboard shortcuts hint */
    .kbd {
      background: var(--c-bg-800);
      border: 1px solid var(--c-slate-600);
      border-radius: 0.25rem;
      padding: 0.125rem 0.375rem;
      font-size: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal.active {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-content {
      background: var(--c-bg-800);
      border: 1px solid var(--c-slate-600);
      border-radius: 0.75rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s;
    }
    .modal.active .modal-content {
      transform: scale(1);
    }

    /* Collapsible sections */
    .collapsible {
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .collapsible.collapsed {
      max-height: 0 !important;
    }

    /* Search highlight */
    .highlight {
      background: rgba(250, 204, 21, 0.3);
      border-radius: 2px;
    }

    /* Loading skeleton */
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, var(--c-bg-800) 25%, var(--c-bg-900) 50%, var(--c-bg-800) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 0.25rem;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .metric-card { padding: 0.75rem; }
      .log-entry { font-size: 0.75rem; padding: 2px 8px; }
      .connection-status { top: 0.5rem; right: 0.5rem; font-size: 0.625rem; }
      .toast { bottom: 1rem; right: 1rem; left: 1rem; max-width: none; }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Print styles */
    @media print {
      body { background: white; color: black; }
      .no-print { display: none !important; }
      .metric-card { break-inside: avoid; }
    }
  </style>
</head>

<body>
  <div class="bg-particles"></div>
  
  <!-- Connection Status Indicator -->
  <div id="connectionStatus" class="connection-status disconnected no-print">
    <span class="status-icon">‚óè</span>
    <span class="status-text">Disconnected</span>
  </div>

  <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-8">

    <!-- ---------- HEADER ---------- -->
    <header class="text-center space-y-4 mb-8 select-none">
      <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text
                 bg-gradient-to-r from-purple-500 via-pink-500 to-green-400
                 neon-text-glow">
        Pyrmethus's Neon Grimoire
      </h1>
      <p class="text-lg text-slate-400">Transcending market chaos through algorithmic sorcery</p>
      
      <!-- Control buttons -->
      <div class="flex flex-wrap justify-center gap-3 mt-4">
        <button id="themeToggle" class="btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm"
                aria-label="Toggle theme">
          <span class="theme-icon">üåô</span> <span class="theme-text">Dark Mode</span>
        </button>
        <button id="soundToggle" class="btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm"
                aria-label="Toggle sounds">
          <span class="sound-icon">üîä</span> <span class="sound-text">Sounds On</span>
        </button>
        <button id="keyboardShortcuts" class="btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm"
                aria-label="Show keyboard shortcuts">
          ‚å®Ô∏è Shortcuts
        </button>
        <button id="statsToggle" class="btn px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm"
                aria-label="Show session statistics">
          üìä Stats
        </button>
      </div>
    </header>

    <!-- ---------- CONFIGURATION ---------- -->
    <section class="dark:bg-slate-800 p-6 rounded-xl shadow-lg border-2 dark:border-slate-700 hover:border-purple-600 transition-all">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-purple-400">Configuration</h2>
        <button id="collapseConfig" class="text-slate-400 hover:text-slate-200" aria-label="Toggle section">
          <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
      </div>
      
      <div id="configContent" class="collapsible" style="max-height: 1000px;">
        <p class="text-sm text-slate-500 mb-4">
          <strong class="text-red-400">‚ö†Ô∏è WARNING:</strong> API keys are transmitted to the backend. Ensure HTTPS and secure storage.
        </p>
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label for="symbol" class="block text-sm font-medium mb-1">Trading Symbol</label>
            <select id="symbol" class="input-field">
              <option value="TRUMPUSDT" selected>TRUMPUSDT</option>
              <option value="BTCUSDT">BTCUSDT</option>
              <option value="ETHUSDT">ETHUSDT</option>
              <option value="SOLUSDT">SOLUSDT</option>
              <option value="BNBUSDT">BNBUSDT</option>
              <option value="XRPUSDT">XRPUSDT</option>
            </select>
          </div>
          <div>
            <label for="interval" class="block text-sm font-medium mb-1">Interval</label>
            <select id="interval" class="input-field">
              <option value="1">1 min</option>
              <option value="5">5 min</option>
              <option value="15">15 min</option>
              <option value="30">30 min</option>
              <option value="60" selected>1 hour</option>
              <option value="240">4 hours</option>
              <option value="D">1 day</option>
            </select>
          </div>
        </div>
        
        <div id="numericFields" class="grid md:grid-cols-2 gap-4 mt-4"></div>
        
        <template id="numberInputTemplate">
          <div>
            <label class="block text-sm font-medium mb-1"></label>
            <input type="number" class="input-field" />
          </div>
        </template>
        
        <!-- Config presets -->
        <div class="mt-4">
          <label class="block text-sm font-medium mb-1">Quick Presets</label>
          <div class="flex flex-wrap gap-2">
            <button class="preset-btn px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600" data-preset="conservative">
              üõ°Ô∏è Conservative
            </button>
            <button class="preset-btn px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600" data-preset="balanced">
              ‚öñÔ∏è Balanced
            </button>
            <button class="preset-btn px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600" data-preset="aggressive">
              üöÄ Aggressive
            </button>
          </div>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4 mt-6">
          <button id="startBot" class="btn flex-1 py-3 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 glow-purple font-bold transition-transform hover:scale-105" aria-live="polite">
            <span id="buttonText">Start the Bot</span>
          </button>
          <button id="testConnection" class="btn px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300" title="Test backend connection">
            üîå Test Connection
          </button>
          <button id="copyConfig" class="btn px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300" title="Copy configuration">
            üìã Copy
          </button>
          <button id="importConfig" class="btn px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300" title="Import configuration">
            üìÇ Import
          </button>
          <button id="resetConfig" class="btn px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300" title="Reset to defaults">
            üîÑ Reset
          </button>
        </div>
      </div>
    </section>

    <!-- ---------- DASHBOARD ---------- -->
    <section class="dark:bg-slate-800 p-6 rounded-xl shadow-lg border-2 dark:border-slate-700 hover:border-green-600 transition-all">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-green-400">Live Dashboard</h2>
        <div class="flex items-center gap-4">
          <label class="text-sm text-slate-400">
            <input type="checkbox" id="autoRefresh" checked class="mr-1" />
            Auto-refresh
          </label>
          <button id="refreshDashboard" class="text-slate-400 hover:text-slate-200" aria-label="Refresh dashboard">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </button>
        </div>
      </div>
      
      <div id="metricsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div>
      
      <!-- Chart area -->
      <div id="chartArea" class="mt-6 hidden">
        <h3 class="text-lg font-semibold mb-2 text-slate-300">Price History</h3>
        <div class="chart-container">
          <canvas id="priceChart"></canvas>
        </div>
      </div>
      
      <div class="mt-6 flex flex-col sm:flex-row gap-4">
        <button id="askGemini" class="btn flex-1 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-purple-300 font-bold" aria-live="polite">
          ‚ú® Ask Gemini for Market Insight
        </button>
        <button id="exportLogs" class="btn flex-1 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-blue-300 font-bold">
          üìä Export Trading Logs
        </button>
        <button id="toggleChart" class="btn flex-1 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-green-300 font-bold">
          üìà Toggle Chart
        </button>
      </div>
      
      <p class="mt-4 text-xs text-slate-500 text-right">
        Last update: <span id="lastUpdate">‚Äî</span> | 
        Session: <span id="sessionTime">00:00:00</span>
      </p>
    </section>

    <!-- ---------- LOGS ---------- -->
    <section class="dark:bg-slate-800 p-6 rounded-xl shadow-lg border-2 dark:border-slate-700 hover:border-blue-600 transition-all">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-blue-400">Ritual Log</h2>
        <div class="flex items-center gap-4">
          <input type="search" id="logSearch" placeholder="Search logs..." 
                 class="input-field text-sm w-48 hidden md:block" />
          <select id="logFilter" class="input-field text-sm w-32">
            <option value="">All Types</option>
            <option value="success">Success</option>
            <option value="info">Info</option>
            <option value="warning">Warning</option>
            <option value="error">Error</option>
            <option value="signal">Signal</option>
            <option value="llm">LLM</option>
          </select>
          <button id="clearLogs" class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm">
            Clear
          </button>
        </div>
      </div>
      
      <div id="logArea" class="dark:bg-slate-900 p-4 rounded-lg scrollable-log text-xs font-mono" 
           aria-live="polite" aria-atomic="false">
        <div class="log-entry info">Awaiting your command, Master Pyrmethus‚Ä¶</div>
      </div>
      
      <div class="mt-4 flex justify-between items-center text-xs text-slate-500">
        <span>Total logs: <span id="logCount">1</span></span>
        <span>Filtered: <span id="filteredLogCount">1</span></span>
      </div>
    </section>

    <!-- ---------- SESSION STATS (Hidden by default) ---------- -->
    <section id="statsSection" class="dark:bg-slate-800 p-6 rounded-xl shadow-lg border-2 dark:border-slate-700 hidden">
      <h2 class="text-2xl font-bold text-indigo-400 mb-4">Session Statistics</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card">
          <p class="text-sm text-slate-400">Total Profit/Loss</p>
          <p id="sessionPnL" class="text-xl font-bold text-green-400">$0.00</p>
        </div>
        <div class="metric-card">
          <p class="text-sm text-slate-400">Success Rate</p>
          <p id="sessionWinRate" class="text-xl font-bold text-blue-400">0%</p>
        </div>
        <div class="metric-card">
          <p class="text-sm text-slate-400">Total Trades</p>
          <p id="sessionTrades" class="text-xl font-bold text-purple-400">0</p>
        </div>
        <div class="metric-card">
          <p class="text-sm text-slate-400">Best Trade</p>
          <p id="sessionBestTrade" class="text-xl font-bold text-cyan-400">$0.00</p>
        </div>
      </div>
    </section>
  </main>

  <!-- ---------- MODALS ---------- -->
  <!-- Keyboard Shortcuts Modal -->
  <div id="shortcutsModal" class="modal">
    <div class="modal-content">
      <h3 class="text-xl font-bold mb-4">Keyboard Shortcuts</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span>Start/Stop Bot</span>
          <kbd class="kbd">Ctrl + Enter</kbd>
        </div>
        <div class="flex justify-between">
          <span>Toggle Theme</span>
          <kbd class="kbd">Ctrl + D</kbd>
        </div>
        <div class="flex justify-between">
          <span>Export Logs</span>
          <kbd class="kbd">Ctrl + E</kbd>
        </div>
        <div class="flex justify-between">
          <span>Search Logs</span>
          <kbd class="kbd">Ctrl + F</kbd>
        </div>
        <div class="flex justify-between">
          <span>Copy Config</span>
          <kbd class="kbd">Ctrl + C</kbd>
        </div>
        <div class="flex justify-between">
          <span>Import Config</span>
          <kbd class="kbd">Ctrl + I</kbd>
        </div>
        <div class="flex justify-between">
          <span>Refresh Dashboard</span>
          <kbd class="kbd">F5</kbd>
        </div>
      </div>
      <button class="mt-6 w-full py-2 rounded bg-slate-700 hover:bg-slate-600" onclick="closeModal('shortcutsModal')">
        Close
      </button>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- ---------- AUDIO ---------- -->
  <audio id="notificationSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBi2Gy/DUdw0..." type="audio/wav">
  </audio>

  <script>
    // Enhanced configuration
    const APP_CONFIG = {
      VERSION: '2.0.0',
      SOUNDS_ENABLED_KEY: 'pyrmethus_sounds_enabled',
      THEME_KEY: 'pyrmethus_theme',
      CONFIG_DRAFT_KEY: 'pyrmethus_config_draft',
      RECONNECT_DELAY: 5000,
      MAX_LOG_ENTRIES: 1000,
      CHART_MAX_POINTS: 100,
      NOTIFICATION_DURATION: 5000,
    };

    // Presets configuration
    const PRESETS = {
      conservative: {
        leverage: 5, riskPct: 0.5, stopLossPct: 1, takeProfitPct: 2,
        efPeriod: 14, macdFastPeriod: 12, macdSlowPeriod: 26,
        macdSignalPeriod: 9, bbPeriod: 20, bbStdDev: 2
      },
      balanced: {
        leverage: 10, riskPct: 1, stopLossPct: 2, takeProfitPct: 5,
        efPeriod: 10, macdFastPeriod: 12, macdSlowPeriod: 26,
        macdSignalPeriod: 9, bbPeriod: 20, bbStdDev: 2
      },
      aggressive: {
        leverage: 20, riskPct: 2, stopLossPct: 3, takeProfitPct: 10,
        efPeriod: 8, macdFastPeriod: 8, macdSlowPeriod: 21,
        macdSignalPeriod: 5, bbPeriod: 14, bbStdDev: 2.5
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      /* ========================= UTILITIES ========================= */
      const $ = (selector, context = document) => context.querySelector(selector);
      const $$ = (selector, context = document) => [...context.querySelectorAll(selector)];
      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
      const debounce = (func, wait) => {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      };

      // Sound system
      const SoundManager = {
        enabled: localStorage.getItem(APP_CONFIG.SOUNDS_ENABLED_KEY) !== 'false',
        audio: $('#notificationSound'),
        play(type = 'default') {
          if (this.enabled && this.audio) {
            this.audio.currentTime = 0;
            this.audio.volume = 0.3;
            this.audio.play().catch(() => {});
          }
        },
        toggle() {
          this.enabled = !this.enabled;
          localStorage.setItem(APP_CONFIG.SOUNDS_ENABLED_KEY, this.enabled);
          updateSoundButton();
        }
      };

      // Toast notification system
      const Toast = {
        show(message, type = 'info', duration = APP_CONFIG.NOTIFICATION_DURATION) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `
            <div class="flex items-center justify-between">
              <span>${message}</span>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-slate-400 hover:text-slate-200">‚úï</button>
            </div>
          `;
          $('#toastContainer').appendChild(toast);
          requestAnimationFrame(() => toast.classList.add('show'));
          
          if (type === 'error' || type === 'success') {
            SoundManager.play(type);
          }
          
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
          }, duration);
        }
      };

      // Enhanced logger
      const log = (() => {
        const area = $('#logArea');
        let logCount = 0;
        let logs = [];
        
        return (message, type = 'info') => {
          const timestamp = new Date();
          const timeStr = timestamp.toLocaleTimeString();
          const entry = { message, type, timestamp, id: ++logCount };
          
          logs.push(entry);
          if (logs.length > APP_CONFIG.MAX_LOG_ENTRIES) {
            logs.shift();
            area.firstElementChild?.remove();
          }
          
          const div = document.createElement('div');
          div.className = `log-entry ${type}`;
          div.dataset.type = type;
          div.dataset.timestamp = timestamp.toISOString();
          div.innerHTML = `<span class="text-slate-500 mr-2">[${timeStr}]</span><span>${escapeHtml(message)}</span>`;
          area.appendChild(div);
          
          requestAnimationFrame(() => {
            area.scrollTop = area.scrollHeight;
            updateLogCounts();
          });
          
          // Auto-save draft config on errors
          if (type === 'error') {
            saveDraftConfig();
          }
          
          return entry;
        };
      })();

      // HTML escape function
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Enhanced fetch with retry and progress
      async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000, timeout = 8000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(url, { 
              ...options, 
              signal: controller.signal,
              headers: {
                'Content-Type': 'application/json',
                ...options.headers
              }
            });
            clearTimeout(timeoutId);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response;
          } catch (error) {
            clearTimeout(timeoutId);
            
            if (i === retries - 1) throw error;
            
            const nextDelay = delay * Math.pow(2, i); // Exponential backoff
            log(`Retry ${i + 1}/${retries} in ${nextDelay}ms: ${error.message}`, 'warning');
            await new Promise(resolve => setTimeout(resolve, nextDelay));
          }
        }
      }

      // Formatters
      const fmt = {
        price: (v) => (v == null || v === '---') ? '---' : `$${Number(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 })}`,
        percent: (v) => (v == null || v === '---') ? '---' : `${Number(v).toFixed(2)}%`,
        num: (v) => (v == null || v === '---') ? '---' : Number(v).toLocaleString(),
        dec: (v, p = 4) => (v == null || v === '---') ? '---' : Number(v).toFixed(p),
      };

      /* ========================= CONSTANTS ========================= */
      const BACKEND_URL = new URLSearchParams(window.location.search).get('api') || 
                          window.BACKEND_URL || 
                          'http://127.0.0.1:5000';
      const WEBSOCKET_URL = BACKEND_URL.replace(/^http/, 'ws');

      const NUM_FIELDS = [
        ['leverage', 'Leverage', 10, 1, 100, 1],
        ['riskPct', 'Risk % per Trade', 1, 0.1, 10, 0.1],
        ['stopLossPct', 'Stop Loss %', 2, 0.1, 10, 0.1],
        ['takeProfitPct', 'Take Profit %', 5, 0.1, 20, 0.1],
        ['efPeriod', 'Ehlers-Fisher Period', 10, 1, 50, 1],
        ['macdFastPeriod', 'MACD Fast Period', 12, 2, 100, 1],
        ['macdSlowPeriod', 'MACD Slow Period', 26, 2, 100, 1],
        ['macdSignalPeriod', 'MACD Signal Period', 9, 1, 100, 1],
        ['bbPeriod', 'Bollinger Bands Period', 20, 2, 100, 1],
        ['bbStdDev', 'Bollinger Bands Std Dev', 2, 0.1, 5, 0.1],
      ];

      const METRICS = [
        ['Current Price', 'currentPrice', 'text-cyan-400', fmt.price, '--c-cyan'],
        ['Price Change', 'priceChange', 'text-slate-500', fmt.percent],
        ['Supertrend', 'stDirection', 'text-fuchsia-400', null, '--c-purple'],
        ['ST Value', 'stValue', 'text-slate-500', fmt.price],
        ['RSI', 'rsiValue', 'text-yellow-400', (v) => fmt.dec(v, 2), '--c-yellow'],
        ['RSI Status', 'rsiStatus', 'text-slate-500', null],
        ['Position', 'currentPosition', 'text-pink-400', null, '--c-pink'],
        ['Position PnL', 'positionPnL', 'text-slate-500', fmt.percent],
        ['Balance', 'accountBalance', 'text-blue-400', fmt.price, '--c-blue'],
        ['Ehlers-Fisher', 'fisherValue', 'text-purple-400', (v) => fmt.dec(v, 4)],
        ['MACD Line', 'macdLine', 'text-indigo-400', (v) => fmt.dec(v, 4)],
        ['MACD Signal', 'macdSignal', 'text-blue-400', (v) => fmt.dec(v, 4)],
        ['MACD Hist', 'macdHistogram', 'text-cyan-400', (v) => fmt.dec(v, 4)],
        ['BB Middle', 'bbMiddle', 'text-green-400', fmt.price],
        ['BB Upper', 'bbUpper', 'text-lime-400', fmt.price],
        ['BB Lower', 'bbLower', 'text-teal-400', fmt.price],
        ['Total Trades', 'totalTrades', 'text-emerald-400', fmt.num],
        ['Win Rate', 'winRate', 'text-orange-400', fmt.percent],
        ['Bot Status', 'botStatus', 'text-violet-400', null],
      ];

      /* ==================== DYNAMIC DOM CREATION =================== */
      const numericFieldsContainer = $('#numericFields');
      const template = $('#numberInputTemplate').content;
      
      NUM_FIELDS.forEach(([id, label, def, min, max, step]) => {
        const clone = template.cloneNode(true);
        const labelEl = clone.querySelector('label');
        const inputEl = clone.querySelector('input');
        labelEl.htmlFor = id;
        labelEl.textContent = label;
        Object.assign(inputEl, { id, value: def, min, max, step });
        
        // Add input validation
        inputEl.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          if (!isNaN(value)) {
            e.target.value = clamp(value, min, max);
          }
        });
        
        numericFieldsContainer.appendChild(clone);
      });

      // Create metric cards
      const metricsGrid = $('#metricsGrid');
      METRICS.forEach(([label, id, colorClass, formatter, glowColor]) => {
        const card = document.createElement('div');
        card.className = 'metric-card';
        if (glowColor) card.style.setProperty('--glow-color', `var(${glowColor})`);
        card.innerHTML = `
          <p class="text-xs sm:text-sm text-slate-400">${label}</p>
          <p id="${id}" class="text-lg sm:text-xl font-bold ${colorClass} mt-1">
            <span class="skeleton" style="display: inline-block; width: 60px; height: 1.5em;"></span>
          </p>
        `;
        metricsGrid.appendChild(card);
      });

      /* ========================= STATE MANAGEMENT ======================== */
      let botRunning = false;
      let pollIntervalId = null;
      let sessionTimerId = null;
      let ws = null;
      let sessionStartTime = null;
      let priceHistory = [];
      let priceChart = null;
      let sessionStats = {
        totalPnL: 0,
        trades: 0,
        wins: 0,
        bestTrade: 0
      };

      /* ========================= THEME & UI ======================== */
      const applyTheme = (theme) => {
        document.documentElement.dataset.theme = theme;
        localStorage.setItem(APP_CONFIG.THEME_KEY, theme);
        updateThemeButton(theme);
      };

      const updateThemeButton = (theme) => {
        const icon = $('.theme-icon');
        const text = $('.theme-text');
        if (theme === 'light') {
          icon.textContent = '‚òÄÔ∏è';
          text.textContent = 'Light Mode';
        } else {
          icon.textContent = 'üåô';
          text.textContent = 'Dark Mode';
        }
      };

      const updateSoundButton = () => {
        const icon = $('.sound-icon');
        const text = $('.sound-text');
        if (SoundManager.enabled) {
          icon.textContent = 'üîä';
          text.textContent = 'Sounds On';
        } else {
          icon.textContent = 'üîá';
          text.textContent = 'Sounds Off';
        }
      };

      /* ========================= CONNECTION STATUS ======================== */
      function updateConnectionStatus(status, details = '') {
        const statusEl = $('#connectionStatus');
        const icon = statusEl.querySelector('.status-icon');
        const text = statusEl.querySelector('.status-text');
        
        statusEl.className = 'connection-status no-print';
        
        switch (status) {
          case 'connected':
            statusEl.classList.add('connected');
            icon.textContent = '‚óè';
            text.textContent = 'WebSocket Connected';
            break;
          case 'polling':
            statusEl.classList.add('polling');
            icon.textContent = '‚óê';
            text.textContent = 'Polling Mode';
            break;
          case 'disconnected':
            statusEl.classList.add('disconnected');
            icon.textContent = '‚óã';
            text.textContent = details || 'Disconnected';
            break;
        }
      }

      /* ========================= CONFIGURATION ======================== */
      function getConfig() {
        const config = {
          symbol: $('#symbol').value.toUpperCase(),
          interval: $('#interval').value,
        };
        
        NUM_FIELDS.forEach(([id, , , min, max]) => {
          const input = $(`#${id}`);
          const value = parseFloat(input.value);
          config[id] = clamp(isNaN(value) ? parseFloat(input.defaultValue) : value, min, max);
        });
        
        // Add static config
        Object.assign(config, {
          supertrend_length: 10,
          supertrend_multiplier: 3.0,
          rsi_length: 14,
          rsi_overbought: 70,
          rsi_oversold: 30,
        });
        
        return config;
      }

      function setConfig(config) {
        if (config.symbol) $('#symbol').value = config.symbol;
        if (config.interval) $('#interval').value = config.interval;
        
        NUM_FIELDS.forEach(([id, , , min, max]) => {
          if (config[id] != null) {
            $(`#${id}`).value = clamp(config[id], min, max);
          }
        });
      }

      function saveDraftConfig() {
        localStorage.setItem(APP_CONFIG.CONFIG_DRAFT_KEY, JSON.stringify(getConfig()));
      }

      function loadDraftConfig() {
        try {
          const draft = localStorage.getItem(APP_CONFIG.CONFIG_DRAFT_KEY);
          if (draft) {
            setConfig(JSON.parse(draft));
            log('Draft configuration restored', 'info');
          }
        } catch (e) {
          console.error('Failed to load draft config:', e);
        }
      }

      /* ========================= BOT CONTROL ======================== */
      async function handleStartStop() {
        const btn = $('#startBot');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `${botRunning ? 'Stopping...' : 'Starting...'}<span class="spinner"></span>`;

        try {
          if (botRunning) {
            await stopBot();
          } else {
            await startBot();
          }
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalContent;
        }
      }

      async function startBot() {
        try {
          const config = getConfig();
          const res = await fetchWithRetry(`${BACKEND_URL}/api/start`, {
            method: 'POST',
            body: JSON.stringify(config),
          });
          
          const data = await res.json();
          if (data.status === 'success') {
            log('Bot ritual initiated ‚úîÔ∏è', 'success');
            Toast.show('Bot started successfully!', 'success');
            setRunningState(true);
            initiateConnection();
            startSessionTimer();
          } else {
            throw new Error(data.message || 'Failed to start bot');
          }
        } catch (e) {
          log(`Error starting bot: ${e.message}`, 'error');
          Toast.show(`Failed to start bot: ${e.message}`, 'error');
        }
      }

      async function stopBot() {
        try {
          const res = await fetchWithRetry(`${BACKEND_URL}/api/stop`, { method: 'POST' });
          const data = await res.json();
          
          if (data.status === 'success') {
            log('Bot ritual paused ‚è∏Ô∏è', 'warning');
            Toast.show('Bot stopped', 'warning');
            setRunningState(false);
            stopSessionTimer();
          } else {
            throw new Error(data.message || 'Failed to stop bot');
          }
        } catch (e) {
          log(`Error stopping bot: ${e.message}`, 'error');
          Toast.show(`Failed to stop bot: ${e.message}`, 'error');
        }
      }

      function setRunningState(isRunning) {
        if (botRunning === isRunning) return;
        botRunning = isRunning;
        updateButtonState();
        $('#botStatus').textContent = isRunning ? 'Running' : 'Idle';
        
        if (!isRunning) {
          closeWebSocket();
          clearInterval(pollIntervalId);
          updateConnectionStatus('disconnected');
        }
      }

      function updateButtonState() {
        const btn = $('#startBot');
        const text = $('#buttonText');
        
        text.textContent = botRunning ? 'Stop the Bot' : 'Start the Bot';
        btn.classList.toggle('from-purple-500', !botRunning);
        btn.classList.toggle('to-pink-500', !botRunning);
        btn.classList.toggle('glow-purple', !botRunning);
        btn.classList.toggle('bg-red-600', botRunning);
        btn.classList.toggle('from-red-600', botRunning);
        btn.classList.toggle('to-red-700', botRunning);
        btn.classList.toggle('glow-red', botRunning);
      }

      /* ========================= NETWORKING ======================== */
      function initiateConnection() {
        if (!botRunning) return;
        openWebSocket();
      }

      function openWebSocket() {
        closeWebSocket();
        
        try {
          log('Attempting WebSocket connection...', 'info');
          ws = new WebSocket(`${WEBSOCKET_URL}/ws/status`);
          
          ws.onopen = () => {
            log('WebSocket connected üì°', 'success');
            updateConnectionStatus('connected');
            clearInterval(pollIntervalId);
          };
          
          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              updateDashboard(data);
            } catch (e) {
              log('Failed to parse WebSocket message', 'error');
            }
          };
          
          ws.onerror = (error) => {
            log('WebSocket error', 'error');
            console.error('WebSocket error:', error);
          };
          
          ws.onclose = () => {
            ws = null;
            if (botRunning) {
              log('WebSocket disconnected, falling back to polling', 'warning');
              updateConnectionStatus('polling');
              startPolling();
            }
          };
        } catch (e) {
          log(`WebSocket connection failed: ${e.message}`, 'error');
          startPolling();
        }
      }

      function closeWebSocket() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      function startPolling() {
        clearInterval(pollIntervalId);
        if (!botRunning) return;
        
        pollIntervalId = setInterval(async () => {
          if ($('#autoRefresh').checked) {
            await fetchDashboardStatus();
          }
        }, 5000);
        
        // Immediate fetch
        fetchDashboardStatus();
      }

      async function fetchDashboardStatus() {
        try {
          const res = await fetchWithRetry(`${BACKEND_URL}/api/status`, {}, 2, 1000, 4000);
          const data = await res.json();
          updateDashboard(data);
        } catch (e) {
          log(`Dashboard fetch failed: ${e.message}`, 'error');
          updateConnectionStatus('disconnected', 'Connection Error');
        }
      }

      /* ========================= DASHBOARD UPDATE ======================== */
      let lastLogTimestamp = Date.now();
      
      function updateDashboard(data) {
        const dashboard = data.dashboard || {};
        
        // Update metrics
        METRICS.forEach(([_, id, __, formatter]) => {
          const el = $(`#${id}`);
          if (el) {
            const value = dashboard[id] ?? '---';
            const skeleton = el.querySelector('.skeleton');
            if (skeleton) skeleton.remove();
            el.textContent = formatter ? formatter(value) : value;
          }
        });
        
        // Update timestamp
        $('#lastUpdate').textContent = new Date().toLocaleTimeString();
        
        // Update logs
        if (Array.isArray(data.logs)) {
          data.logs.forEach(logEntry => {
            const timestamp = logEntry.timestamp || Date.now();
            if (timestamp > lastLogTimestamp) {
              log(logEntry.message, logEntry.level);
              lastLogTimestamp = timestamp;
            }
          });
        }
        
        // Update bot state
        if (typeof data.running === 'boolean') {
          setRunningState(data.running);
        }
        
        // Update price history for chart
        if (dashboard.currentPrice && dashboard.currentPrice !== '---') {
          updatePriceHistory(parseFloat(dashboard.currentPrice.replace('$', '').replace(',', '')));
        }
        
        // Update session stats
        updateSessionStats(dashboard);
      }

      /* ========================= CHARTS ======================== */
      function updatePriceHistory(price) {
        priceHistory.push({
          time: new Date(),
          price: price
        });
        
        // Keep only recent data
        if (priceHistory.length > APP_CONFIG.CHART_MAX_POINTS) {
          priceHistory.shift();
        }
        
        if (priceChart && $('#chartArea').classList.contains('hidden') === false) {
          updateChart();
        }
      }

      function initChart() {
        const ctx = $('#priceChart').getContext('2d');
        priceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'Price',
              data: [],
              borderColor: '#A855F7',
              backgroundColor: 'rgba(168, 85, 247, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 4,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: (context) => `Price: ${fmt.price(context.parsed.y)}`
                }
              }
            },
            scales: {
              x: {
                display: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { color: '#94A3B8' }
              },
              y: {
                display: true,
                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                ticks: { 
                  color: '#94A3B8',
                  callback: (value) => fmt.price(value)
                }
              }
            }
          }
        });
        updateChart();
      }

      function updateChart() {
        if (!priceChart) return;
        
        priceChart.data.labels = priceHistory.map(p => p.time.toLocaleTimeString());
        priceChart.data.datasets[0].data = priceHistory.map(p => p.price);
        priceChart.update('none');
      }

      /* ========================= SESSION TRACKING ======================== */
      function startSessionTimer() {
        sessionStartTime = Date.now();
        sessionTimerId = setInterval(updateSessionTime, 1000);
      }

      function stopSessionTimer() {
        clearInterval(sessionTimerId);
        sessionTimerId = null;
      }

      function updateSessionTime() {
        if (!sessionStartTime) return;
        
        const elapsed = Date.now() - sessionStartTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        $('#sessionTime').textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }

      function updateSessionStats(dashboard) {
        // This would be enhanced with actual trade tracking
        if (dashboard.positionPnL && dashboard.positionPnL !== '---') {
          const pnl = parseFloat(dashboard.positionPnL);
          if (!isNaN(pnl)) {
            sessionStats.totalPnL += pnl;
            sessionStats.trades++;
            if (pnl > 0) {
              sessionStats.wins++;
              sessionStats.bestTrade = Math.max(sessionStats.bestTrade, pnl);
            }
          }
        }
        
        $('#sessionPnL').textContent = fmt.price(sessionStats.totalPnL);
        $('#sessionWinRate').textContent = sessionStats.trades > 0 
          ? fmt.percent((sessionStats.wins / sessionStats.trades) * 100)
          : '0%';
        $('#sessionTrades').textContent = sessionStats.trades;
        $('#sessionBestTrade').textContent = fmt.price(sessionStats.bestTrade);
      }

      /* ========================= UI INTERACTIONS ======================== */
      // Theme toggle
      $('#themeToggle').addEventListener('click', () => {
        const newTheme = document.documentElement.dataset.theme === 'light' ? 'dark' : 'light';
        applyTheme(newTheme);
      });

      // Sound toggle
      $('#soundToggle').addEventListener('click', () => SoundManager.toggle());

      // Bot control
      $('#startBot').addEventListener('click', handleStartStop);

      // Test connection
      $('#testConnection').addEventListener('click', async () => {
        const btn = $('#testConnection');
        btn.disabled = true;
        btn.innerHTML = 'Testing...<span class="spinner"></span>';
        
        try {
          const res = await fetchWithRetry(`${BACKEND_URL}/api/status`, {}, 1, 1000, 3000);
          if (res.ok) {
            Toast.show('Connection successful!', 'success');
          } else {
            Toast.show('Connection failed', 'error');
          }
        } catch (e) {
          Toast.show(`Connection error: ${e.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'üîå Test Connection';
        }
      });

      // Config operations
      $('#copyConfig').addEventListener('click', async () => {
        try {
          const config = JSON.stringify(getConfig(), null, 2);
          await navigator.clipboard.writeText(config);
          Toast.show('Configuration copied to clipboard', 'success');
        } catch (e) {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = JSON.stringify(getConfig(), null, 2);
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          Toast.show('Configuration copied to clipboard', 'success');
        }
      });

      $('#importConfig').addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          try {
            const text = await file.text();
            const config = JSON.parse(text);
            setConfig(config);
            Toast.show('Configuration imported successfully', 'success');
            saveDraftConfig();
          } catch (e) {
            Toast.show('Invalid configuration file', 'error');
          }
        };
        input.click();
      });

      $('#resetConfig').addEventListener('click', () => {
        if (confirm('Reset all settings to defaults?')) {
          NUM_FIELDS.forEach(([id, , def]) => {
            $(`#${id}`).value = def;
          });
          $('#symbol').value = 'TRUMPUSDT';
          $('#interval').value = '60';
          Toast.show('Configuration reset to defaults', 'info');
          localStorage.removeItem(APP_CONFIG.CONFIG_DRAFT_KEY);
        }
      });

      // Preset buttons
      $$('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const preset = PRESETS[btn.dataset.preset];
          if (preset) {
            setConfig(preset);
            Toast.show(`Applied ${btn.dataset.preset} preset`, 'info');
          }
        });
      });

      // Dashboard controls
      $('#refreshDashboard').addEventListener('click', () => {
        fetchDashboardStatus();
        const icon = $('#refreshDashboard svg');
        icon.style.animation = 'spin 0.5s linear';
        setTimeout(() => icon.style.animation = '', 500);
      });

      $('#askGemini').addEventListener('click', askGemini);
      
      $('#exportLogs').addEventListener('click', () => {
        const logs = $$('#logArea .log-entry');
        const format = prompt('Export format: "text", "json", or "csv"', 'text');
        
        if (!format) return;
        
        let content, filename, mimeType;
        
        switch (format.toLowerCase()) {
          case 'json':
            content = JSON.stringify(logs.map(el => ({
              timestamp: el.dataset.timestamp,
              type: el.dataset.type,
              message: el.textContent
            })), null, 2);
            filename = `logs_${new Date().toISOString().slice(0, 10)}.json`;
            mimeType = 'application/json';
            break;
            
          case 'csv':
            content = 'Timestamp,Type,Message\n' + logs.map(el => 
              `"${el.dataset.timestamp}","${el.dataset.type}","${el.textContent.replace(/"/g, '""')}"`
            ).join('\n');
            filename = `logs_${new Date().toISOString().slice(0, 10)}.csv`;
            mimeType = 'text/csv';
            break;
            
          default:
            content = logs.map(el => el.textContent).join('\n');
            filename = `logs_${new Date().toISOString().slice(0, 10)}.txt`;
            mimeType = 'text/plain';
        }
        
        const blob = new Blob([content], { type: mimeType });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        Toast.show(`Logs exported as ${format}`, 'success');
      });

      $('#toggleChart').addEventListener('click', () => {
        const chartArea = $('#chartArea');
        const isHidden = chartArea.classList.toggle('hidden');
        
        if (!isHidden && !priceChart) {
          initChart();
        }
        
        Toast.show(isHidden ? 'Chart hidden' : 'Chart visible', 'info');
      });

      // Log controls
      $('#clearLogs').addEventListener('click', () => {
        if (confirm('Clear all logs?')) {
          $('#logArea').innerHTML = '<div class="log-entry info">Logs cleared. Awaiting commands...</div>';
          lastLogTimestamp = Date.now();
          updateLogCounts();
          Toast.show('Logs cleared', 'info');
        }
      });

      const logSearch = $('#logSearch');
      const logFilter = $('#logFilter');
      
      const filterLogs = debounce(() => {
        const searchTerm = logSearch.value.toLowerCase();
        const filterType = logFilter.value;
        const logs = $$('#logArea .log-entry');
        let visibleCount = 0;
        
        logs.forEach(log => {
          const matchesSearch = !searchTerm || log.textContent.toLowerCase().includes(searchTerm);
          const matchesType = !filterType || log.dataset.type === filterType;
          const isVisible = matchesSearch && matchesType;
          
          log.style.display = isVisible ? '' : 'none';
          if (isVisible) visibleCount++;
          
          // Highlight search term
          if (searchTerm && matchesSearch) {
            const text = log.querySelector('span:last-child');
            const original = text.textContent;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            text.innerHTML = escapeHtml(original).replace(regex, '<span class="highlight">$1</span>');
          }
        });
        
        $('#filteredLogCount').textContent = visibleCount;
      }, 300);
      
      logSearch.addEventListener('input', filterLogs);
      logFilter.addEventListener('change', filterLogs);

      function updateLogCounts() {
        const total = $$('#logArea .log-entry').length;
        const visible = $$('#logArea .log-entry:not([style*="display: none"])').length;
        $('#logCount').textContent = total;
        $('#filteredLogCount').textContent = visible;
      }

      // Collapsible sections
      $('#collapseConfig').addEventListener('click', () => {
        const content = $('#configContent');
        const icon = $('#collapseConfig svg');
        const isCollapsed = content.classList.toggle('collapsed');
        
        if (isCollapsed) {
          content.style.maxHeight = '0';
          icon.style.transform = 'rotate(-90deg)';
        } else {
          content.style.maxHeight = content.scrollHeight + 'px';
          icon.style.transform = 'rotate(0)';
        }
      });

      // Stats toggle
      $('#statsToggle').addEventListener('click', () => {
        const section = $('#statsSection');
        const isHidden = section.classList.toggle('hidden');
        Toast.show(isHidden ? 'Stats hidden' : 'Stats visible', 'info');
      });

      // Keyboard shortcuts
      $('#keyboardShortcuts').addEventListener('click', () => {
        $('#shortcutsModal').classList.add('active');
      });

      window.closeModal = (modalId) => {
        $(`#${modalId}`).classList.remove('active');
      };

      // Global keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in inputs
        if (e.target.matches('input, textarea, select')) return;
        
        if (e.ctrlKey || e.metaKey) {
          switch (e.key.toLowerCase()) {
            case 'enter':
              e.preventDefault();
              handleStartStop();
              break;
            case 'd':
              e.preventDefault();
              $('#themeToggle').click();
              break;
            case 'e':
              e.preventDefault();
              $('#exportLogs').click();
              break;
            case 'f':
              e.preventDefault();
              logSearch.focus();
              break;
            case 'c':
              if (!e.shiftKey) {
                e.preventDefault();
                $('#copyConfig').click();
              }
              break;
            case 'i':
              e.preventDefault();
              $('#importConfig').click();
              break;
          }
        } else if (e.key === 'F5') {
          e.preventDefault();
          $('#refreshDashboard').click();
        }
      });

      /* ========================= ADVANCED FEATURES ======================== */
      async function askGemini() {
        const btn = $('#askGemini');
        btn.disabled = true;
        btn.innerHTML = 'Consulting the Oracle‚Ä¶<span class="spinner"></span>';
        log('Consulting the Gemini Oracle...', 'llm');
        
        const metrics = {
          symbol: $('#symbol').value,
          price: $('#currentPrice').textContent,
          trend: $('#stDirection').textContent,
          rsi: $('#rsiValue').textContent,
          macd: $('#macdLine').textContent,
          position: $('#currentPosition').textContent,
        };
        
        const prompt = `Analyze ${metrics.symbol} with current metrics:
Price: ${metrics.price}
Supertrend: ${metrics.trend}
RSI: ${metrics.rsi}
MACD: ${metrics.macd}
Position: ${metrics.position}

Provide a concise technical analysis focusing on:
1. Current market structure
2. Key support/resistance levels
3. Momentum indicators alignment
4. Risk factors

Keep it under 150 words, neutral and factual.`;

        try {
          const res = await fetchWithRetry(`${BACKEND_URL}/api/gemini-insight`, {
            method: 'POST',
            body: JSON.stringify({ prompt })
          }, 2, 2000, 15000);
          
          const data = await res.json();
          if (data.status === 'success') {
            log('‚ïê‚ïê‚ïê Gemini Oracle Insight ‚ïê‚ïê‚ïê', 'llm');
            log(data.insight, 'llm');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'llm');
            Toast.show('Gemini insight received', 'success');
          } else {
            throw new Error(data.message || 'Gemini request failed');
          }
        } catch (e) {
          log(`Oracle error: ${e.message}`, 'error');
          Toast.show('Failed to get Gemini insight', 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '‚ú® Ask Gemini for Market Insight';
        }
      }

      /* ========================= INITIALIZATION ======================== */
      // Set initial theme
      const savedTheme = localStorage.getItem(APP_CONFIG.THEME_KEY) || 'dark';
      applyTheme(savedTheme);
      
      // Set initial sound state
      updateSoundButton();
      
      // Load draft config if exists
      loadDraftConfig();
      
      // Auto-save config on changes
      $$('input, select').forEach(el => {
        el.addEventListener('change', debounce(saveDraftConfig, 1000));
      });
      
      // Initial dashboard fetch
      fetchDashboardStatus();
      
      // Show version
      log(`Grimoire v${APP_CONFIG.VERSION} initialized ‚ú®`, 'success');
      Toast.show('Welcome to Pyrmethus\'s Neon Grimoire', 'info', 3000);
      
      // Check for updates periodically
      setInterval(() => {
        if (!botRunning && $('#autoRefresh').checked) {
          fetchDashboardStatus();
        }
      }, 30000);

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        closeWebSocket();
        saveDraftConfig();
      });
    });
  </script>
</body>
</html>
