<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŒŠ WhaleWave Titan + Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --neon-green: #00ff41;
            --neon-red: #ff1e1e;
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --bg-dark: #050505;
            --panel: rgba(18, 18, 20, 0.9);
        }

        body {
            background-color: var(--bg-dark);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            background-image: radial-gradient(circle at 50% 0%, #111 0%, #000 80%);
            overflow-x: hidden;
        }

        .orbitron { font-family: 'Orbitron', monospace; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .text-green-glow { color: var(--neon-green); text-shadow: 0 0 10px rgba(0, 255, 65, 0.4); }
        .text-red-glow { color: var(--neon-red); text-shadow: 0 0 10px rgba(255, 30, 30, 0.4); }
        .text-blue-glow { color: var(--neon-blue); text-shadow: 0 0 10px rgba(0, 243, 255, 0.4); }
        .text-purple-glow { color: var(--neon-purple); text-shadow: 0 0 10px rgba(188, 19, 254, 0.4); }

        .glass-panel {
            background: var(--panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* Orderbook */
        .ob-row {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr;
            font-size: 0.75rem;
            padding: 2px 6px;
            position: relative;
        }
        .ob-row:hover { background: rgba(255,255,255,0.05); }
        
        .ob-bg {
            position: absolute; top: 0; bottom: 0; z-index: -1;
            opacity: 0.15; transition: width 0.15s ease-out;
        }
        .bg-ask { background-color: var(--neon-red); right: 0; }
        .bg-bid { background-color: var(--neon-green); right: 0; }

        /* AI Markdown Styling */
        .ai-content p { margin-bottom: 0.5em; font-size: 0.75rem; line-height: 1.4; color: #cbd5e1; }
        .ai-content strong { color: var(--neon-blue); font-weight: 700; }
        .ai-typing::after { content: 'â–‹'; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Modal */
        #settings-modal { transition: opacity 0.3s ease; }
        .hidden-modal { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-2 lg:p-4 gap-4">

    <!-- Header -->
    <header class="flex justify-between items-center glass-panel px-6 py-3 sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <div class="relative">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500 transition-colors duration-500"></div>
                <div id="status-ping" class="absolute inset-0 rounded-full bg-red-500 opacity-0 transition-opacity"></div>
            </div>
            <div>
                <h1 class="text-xl font-bold orbitron tracking-wider text-white">WHALEWAVE<span class="text-purple-glow text-xs ml-1">AI</span></h1>
                <div class="text-[0.65rem] text-gray-400 font-mono flex gap-3">
                    <span id="latency">--ms LAG</span> | <span>BYBIT V5</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4 text-sm font-mono">
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden-modal')" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded border border-gray-600 text-xs text-blue-glow transition-colors">
                <i data-lucide="key" class="w-3 h-3 inline mr-1"></i>API KEY
            </button>
            <div class="text-right hidden sm:block">
                <div class="text-gray-500 text-xs">PNL</div>
                <div id="header-pnl" class="text-white font-bold">$0.00</div>
            </div>
        </div>
    </header>

    <!-- Main Grid -->
    <main class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4">
        
        <!-- LEFT: Market Data (3 Cols) -->
        <section class="lg:col-span-3 flex flex-col gap-4">
            <div class="glass-panel p-5 text-center relative overflow-hidden">
                <div class="text-xs text-gray-500 tracking-[0.3em] mb-1">BTCUSDT PERP</div>
                <div id="ticker-price" class="text-4xl font-bold orbitron text-white transition-colors duration-100">00,000.00</div>
            </div>

            <div class="glass-panel flex-1 flex flex-col overflow-hidden min-h-[500px]">
                <div class="p-2 border-b border-gray-800 grid grid-cols-3 text-[0.6rem] text-gray-500 font-bold px-2">
                    <span class="text-blue-glow">PRICE</span>
                    <span class="text-center">QTY</span>
                    <span class="text-right">TOTAL</span>
                </div>
                <div id="ob-asks" class="flex-1 overflow-hidden flex flex-col-reverse"></div>
                
                <div class="py-2 bg-gray-900 border-y border-gray-800 px-3">
                    <div class="flex justify-between text-xs font-mono mb-1">
                        <span class="text-gray-500">Spread: <span id="ob-spread" class="text-white">0.00</span></span>
                        <span class="text-gray-500">Imbalance: <span id="imbalance-pct" class="text-white">50%</span></span>
                    </div>
                    <div class="w-full h-1 bg-gray-800 rounded overflow-hidden flex">
                        <div id="imbalance-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 50%"></div>
                    </div>
                </div>

                <div id="ob-bids" class="flex-1 overflow-hidden flex flex-col"></div>
            </div>
        </section>

        <!-- CENTER: Analysis & AI (6 Cols) -->
        <section class="lg:col-span-6 flex flex-col gap-4">
            
            <!-- WSS & AI Header -->
            <div class="glass-panel p-6 relative flex flex-col sm:flex-row justify-between items-center gap-4 overflow-hidden">
                <div id="wss-pulse" class="absolute inset-0 bg-blue-500/5 rounded-xl blur-3xl opacity-0 transition-opacity duration-500"></div>
                
                <div class="relative z-10 flex-1">
                    <h3 class="text-purple-glow text-xs font-bold tracking-widest mb-1 flex items-center gap-2">
                        <i data-lucide="cpu" class="w-3 h-3"></i> DECISION ENGINE
                    </h3>
                    <div class="flex items-baseline gap-4">
                        <span id="wss-score" class="text-6xl font-black orbitron text-gray-700 transition-colors duration-300">0.00</span>
                        <div>
                            <div id="wss-action" class="text-3xl font-bold text-gray-500">WAIT</div>
                            <div id="wss-reasons" class="text-[0.65rem] text-gray-400 font-mono">Initializing data...</div>
                        </div>
                    </div>
                </div>

                <!-- Gemini AI Output Box -->
                <div class="relative z-10 w-full sm:w-1/2 bg-black/40 rounded-lg border border-gray-800 p-3 h-32 overflow-y-auto custom-scroll">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[0.6rem] text-blue-glow font-bold"><i data-lucide="sparkles" class="w-3 h-3 inline"></i> GEMINI ANALYSIS</span>
                        <span id="ai-status" class="text-[0.6rem] text-gray-600">IDLE</span>
                    </div>
                    <div id="ai-output" class="ai-content text-xs text-gray-300">
                        Enter API Key to enable AI analysis.
                    </div>
                </div>
            </div>

            <!-- Indicators Grid -->
            <div class="glass-panel p-4 grid grid-cols-4 gap-3">
                <h3 class="col-span-4 text-xs text-gray-500 font-bold tracking-wider mb-2">TECHNICAL MATRIX</h3>
                <!-- RSI -->
                <div class="bg-black/30 p-3 rounded border border-gray-800">
                    <span class="text-[0.6rem] text-gray-500 block">RSI (14)</span>
                    <span id="ind-rsi" class="text-lg font-mono font-bold text-white">--</span>
                </div>
                <!-- SuperTrend -->
                <div class="bg-black/30 p-3 rounded border border-gray-800">
                    <span class="text-[0.6rem] text-gray-500 block">SUPERTREND</span>
                    <span id="ind-st" class="text-sm font-mono font-bold text-white">--</span>
                </div>
                <!-- Fisher -->
                <div class="bg-black/30 p-3 rounded border border-gray-800">
                    <span class="text-[0.6rem] text-gray-500 block">FISHER (10)</span>
                    <span id="ind-fisher" class="text-lg font-mono font-bold text-white">--</span>
                </div>
                 <!-- ADX -->
                 <div class="bg-black/30 p-3 rounded border border-gray-800">
                    <span class="text-[0.6rem] text-gray-500 block">ADX (14)</span>
                    <span id="ind-adx" class="text-lg font-mono font-bold text-white">--</span>
                </div>
            </div>

            <!-- Active Position -->
            <div class="flex-1 glass-panel p-4 flex flex-col justify-center items-center border border-dashed border-gray-800 rounded-lg bg-black/20">
                <div id="pos-idle" class="text-center opacity-50">
                    <i data-lucide="crosshair" class="w-10 h-10 mx-auto mb-2"></i>
                    <p class="text-xs">ENGINE IDLE</p>
                </div>
                <div id="pos-active" class="hidden w-full p-2">
                    <div class="flex justify-between items-center border-b border-gray-800 pb-2 mb-2">
                        <span id="pos-side" class="text-base font-black px-2 py-1 rounded">LONG</span>
                        <span id="pos-pnl" class="text-2xl font-bold orbitron text-white">0.00</span>
                    </div>
                    <div class="flex justify-between text-xs font-mono text-gray-400">
                        <span>ENT: <span id="pos-entry" class="text-white"></span></span>
                        <span>SL: <span id="pos-sl" class="text-red-400"></span></span>
                        <span>TP: <span id="pos-tp" class="text-green-400"></span></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- RIGHT: Logs (3 Cols) -->
        <section class="lg:col-span-3 glass-panel p-4 flex flex-col h-full">
            <h3 class="text-xs text-blue-glow font-bold mb-3 tracking-wider">EVENT LOG</h3>
            <div id="app-logs" class="flex-1 overflow-y-auto font-mono text-[0.65rem] space-y-1 pr-1 custom-scroll"></div>
        </section>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center hidden-modal">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-lg max-w-md w-full shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Settings</h2>
            <div class="mb-4">
                <label class="block text-xs text-gray-400 mb-1">Google Gemini API Key</label>
                <input type="password" id="api-key-input" class="w-full bg-black border border-gray-700 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none" placeholder="AIzaSy...">
                <p class="text-[0.6rem] text-gray-500 mt-1">Key is stored in browser memory only.</p>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden-modal')" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded text-xs">Close</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold">Save & Activate</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script>
        lucide.createIcons();

        // ==========================================
        // 1. CONFIG & UTILS
        // ==========================================
        const CONFIG = {
            symbol: 'BTCUSDT',
            wsUrl: 'wss://stream.bybit.com/v5/public/linear',
            geminiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',
            apiKey: localStorage.getItem('GEMINI_KEY') || ''
        };

        const Utils = {
            formatCurrency: (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n),
            clamp: (num, min, max) => Math.min(Math.max(num, min), max),
            
            log: (msg, type = 'info') => {
                const con = document.getElementById('app-logs');
                const time = new Date().toLocaleTimeString().split(' ')[0];
                const color = type === 'buy' ? 'text-green-400' : type === 'sell' ? 'text-red-400' : 'text-gray-400';
                const row = Object.assign(document.createElement('div'), { 
                    className: `${color} border-b border-gray-800/30 pb-0.5`, 
                    innerHTML: `<span class="opacity-50">[${time}]</span> ${msg}` 
                });
                con.prepend(row);
                if(con.children.length > 50) con.lastChild.remove();
            },

            toast: (msg, color='blue') => {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `bg-gray-900 border border-${color}-500 text-white px-4 py-2 rounded shadow-lg text-xs font-mono transform transition-all duration-300 translate-y-10 opacity-0`;
                t.innerHTML = `<span class="w-2 h-2 rounded-full bg-${color}-500 inline-block mr-2"></span>${msg}`;
                c.appendChild(t);
                requestAnimationFrame(() => t.classList.remove('translate-y-10', 'opacity-0'));
                setTimeout(() => { t.classList.add('opacity-0', 'translate-x-10'); setTimeout(() => t.remove(), 300); }, 3000);
            }
        };

        // ==========================================
        // 2. MATH ENGINE (TA)
        // ==========================================
        const TA = {
            sma: (d, l) => d.slice(-l).reduce((a,b)=>a+b,0)/l,
            ema: (p, prev, l) => (p * (2/(l+1))) + (prev * (1 - (2/(l+1)))),
            tr: (h, l, pc) => Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc)),
            
            atr: (c, l, prev) => {
                if(c.length < l+1) return 0;
                const tr = TA.tr(c[c.length-1].h, c[c.length-1].l, c[c.length-2].c);
                return prev ? (prev * (l-1) + tr)/l : TA.sma(c.map((_,i)=>i>0?TA.tr(c[i].h,c[i].l,c[i-1].c):0).slice(1), l);
            },

            rsi: (c, l) => {
                if(c.length < l+1) return 50;
                let g=0, loss=0;
                for(let i=c.length-l; i<c.length; i++) {
                    const d = c[i] - c[i-1];
                    d>0 ? g+=d : loss-=d;
                }
                return loss===0 ? 100 : 100 - (100/(1+(g/loss)));
            },

            fisher: (h, l, len, prev) => {
                if(h.length < len) return {val:0, fish:0};
                const mx = Math.max(...h.slice(-len)), mn = Math.min(...l.slice(-len));
                const hl2 = (h[h.length-1] + l[l.length-1])/2;
                let val = 0.33 * 2 * ((hl2 - mn)/(mx - mn || 1) - 0.5) + 0.67 * (prev?.val||0);
                val = Utils.clamp(val, -0.99, 0.99);
                return { val, fish: 0.5 * Math.log((1+val)/(1-val)) + 0.5 * (prev?.fish||0) };
            },

            adx: (candles, len) => {
                if(candles.length < len*2) return 20;
                // Simplified relative strength of trend
                const change = Math.abs(candles[candles.length-1].c - candles[candles.length-len].c);
                const volatility = TA.atr(candles, len);
                return Math.min((change/volatility)*15 + 10, 70); 
            },

            supertrend: (candles, len=10, mult=3, prevSt) => {
                if(candles.length < len) return { val: 0, dir: 1 };
                const c = candles[candles.length-1];
                const atr = TA.atr(candles, len, prevSt?.atr);
                const hl2 = (c.h + c.l) / 2;
                const basicUpper = hl2 + (mult * atr);
                const basicLower = hl2 - (mult * atr);
                
                let dir = prevSt?.dir || 1;
                let upper = (prevSt?.upper && basicUpper < prevSt.upper || candles[candles.length-2].c > prevSt?.upper) ? basicUpper : prevSt?.upper || basicUpper;
                let lower = (prevSt?.lower && basicLower > prevSt.lower || candles[candles.length-2].c < prevSt?.lower) ? basicLower : prevSt?.lower || basicLower;

                if (dir === 1 && c.c < lower) dir = -1;
                else if (dir === -1 && c.c > upper) dir = 1;

                return { val: dir === 1 ? lower : upper, dir, upper, lower, atr };
            }
        };

        // ==========================================
        // 3. AI SERVICE (Gemini)
        // ==========================================
        class GeminiService {
            constructor() {
                this.lastCall = 0;
                this.isProcessing = false;
            }

            async analyze(data, wss) {
                if (!CONFIG.apiKey || this.isProcessing || Date.now() - this.lastCall < 45000) return; // Rate limit 45s
                
                this.isProcessing = true;
                document.getElementById('ai-status').textContent = "THINKING...";
                document.getElementById('ai-status').className = "text-[0.6rem] text-blue-glow animate-pulse";

                const prompt = `
                    Act as a crypto scalping expert. Asset: BTCUSDT. Price: ${data.price}.
                    Indicators: RSI=${data.indicators.rsi.toFixed(1)}, Fisher=${data.indicators.fisher.toFixed(2)}, ADX=${data.indicators.adx.toFixed(0)}, SuperTrend=${data.indicators.st.dir===1?'BULL':'BEAR'}.
                    Signal Score: ${wss.score.toFixed(1)} (${wss.action}).
                    Orderbook Imbalance: ${(data.imbalance*100).toFixed(0)}% (Higher is Bid heavy).
                    Briefly analyze market condition and give a bias (Bullish/Bearish/Neutral) and 1 sentence reasoning. Max 30 words.
                `;

                try {
                    const response = await fetch(`${CONFIG.geminiUrl}?key=${CONFIG.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const json = await response.json();
                    const text = json.candidates[0].content.parts[0].text;
                    this.typeWriter(text);
                    this.lastCall = Date.now();
                } catch (e) {
                    console.error("AI Error", e);
                    document.getElementById('ai-output').textContent = "AI Error: Check API Key";
                } finally {
                    this.isProcessing = false;
                    document.getElementById('ai-status').textContent = "IDLE";
                    document.getElementById('ai-status').className = "text-[0.6rem] text-gray-600";
                }
            }

            typeWriter(text) {
                const el = document.getElementById('ai-output');
                el.innerHTML = '';
                el.classList.add('ai-typing');
                let i = 0;
                const speed = 20;
                const type = () => {
                    if (i < text.length) {
                        el.innerHTML = marked.parse(text.substring(0, i + 1));
                        i++;
                        setTimeout(type, speed);
                    } else {
                        el.classList.remove('ai-typing');
                    }
                };
                type();
            }
        }
        const AI = new GeminiService();

        // ==========================================
        // 4. DATA MANAGER
        // ==========================================
        class DataManager {
            constructor() {
                this.price = 0;
                this.candles = [];
                this.asks = new Map();
                this.bids = new Map();
                this.imbalance = 0.5;
                this.indicators = { prevSt: null };
                this.trading = { position: null, pnl: 0 };
                
                // Seed data
                const p = 65000;
                for(let i=0; i<150; i++) this.candles.push({t: Date.now()-i*60000, o:p, h:p+10, l:p-10, c:p});
            }

            updateCandle(k) {
                const c = { t: k.start, o: parseFloat(k.open), h: parseFloat(k.high), l: parseFloat(k.low), c: parseFloat(k.close) };
                const last = this.candles[this.candles.length-1];
                if(last && last.t === c.t) this.candles[this.candles.length-1] = c;
                else {
                    this.candles.push(c);
                    if(this.candles.length > 200) this.candles.shift();
                }
                this.price = c.c;
                TechnicalEngine.run();
            }

            updateBook(data) {
                const proc = (l, m) => l.forEach(i => parseFloat(i[1])===0 ? m.delete(parseFloat(i[0])) : m.set(parseFloat(i[0]), parseFloat(i[1])));
                if(data.type === 'snapshot') { this.asks.clear(); this.bids.clear(); }
                proc(data.data.a, this.asks);
                proc(data.data.b, this.bids);
                
                // Calc Imbalance (Top 5 levels)
                let va=0, vb=0;
                Array.from(this.asks).sort((a,b)=>a[0]-b[0]).slice(0,5).forEach(x=>va+=x[1]);
                Array.from(this.bids).sort((a,b)=>b[0]-a[0]).slice(0,5).forEach(x=>vb+=x[1]);
                this.imbalance = vb / (va + vb) || 0.5;
            }
        }
        const DM = new DataManager();

        // ==========================================
        // 5. TECHNICAL & DECISION ENGINE
        // ==========================================
        const TechnicalEngine = {
            run: () => {
                const c = DM.candles;
                const h = c.map(x=>x.h), l = c.map(x=>x.l), cl = c.map(x=>x.c);
                const i = DM.indicators;

                // Calcs
                i.rsi = TA.rsi(cl, 14);
                i.adx = TA.adx(c, 14);
                
                // Stateful Fish
                const fish = TA.fisher(h, l, 10, i.prevFish);
                i.fisher = fish.fish;
                i.prevFish = fish;

                // Stateful SuperTrend
                const st = TA.supertrend(c, 10, 3, i.prevSt);
                i.st = st;
                i.prevSt = st;

                TechnicalEngine.wss();
                Trader.tick();
            },

            wss: () => {
                const i = DM.indicators;
                let score = 0;
                let reasons = [];

                if(i.rsi < 30) { score += 1.5; reasons.push('RSI OS'); }
                if(i.rsi > 70) { score -= 1.5; reasons.push('RSI OB'); }
                
                if(i.fisher > 1.5) { score += 2; reasons.push('Fish Bull'); }
                if(i.fisher < -1.5) { score -= 2; reasons.push('Fish Bear'); }
                
                if(i.st.dir === 1) { score += 1; reasons.push('ST Bull'); }
                else { score -= 1; reasons.push('ST Bear'); }

                if(DM.imbalance > 0.6) { score += 1; reasons.push('Bid Pressure'); }
                else if(DM.imbalance < 0.4) { score -= 1; reasons.push('Ask Pressure'); }

                let action = 'WAIT';
                if (Math.abs(score) >= 3.5) {
                    if (score > 0) action = 'BUY';
                    else action = 'SELL';
                    // Trigger AI Analysis on high conviction
                    AI.analyze(DM, {score, action}); 
                }

                DM.wss = { score: Utils.clamp(score, -5, 5), action, reasons: reasons.join(', ') || 'Neutral' };
            }
        };

        // ==========================================
        // 6. TRADER (SIMULATION)
        // ==========================================
        const Trader = {
            tick: () => {
                const p = DM.trading.position;
                const wss = DM.wss;
                
                if(!p && wss.action !== 'WAIT') {
                    Trader.open(wss.action === 'BUY' ? 'LONG' : 'SHORT');
                } else if (p) {
                    Trader.manage(wss.action);
                }
            },

            open: (side) => {
                const pr = DM.price;
                const atr = DM.indicators.st.atr || 100;
                DM.trading.position = {
                    side, entry: pr,
                    sl: side==='LONG' ? pr - (atr*1.5) : pr + (atr*1.5),
                    tp: side==='LONG' ? pr + (atr*2.5) : pr - (atr*2.5),
                    pnl: 0
                };
                Utils.log(`OPEN ${side} @ ${pr}`, side==='LONG'?'buy':'sell');
                Utils.toast(`Opened ${side}`, side==='LONG'?'green':'red');
            },

            manage: (signal) => {
                const p = DM.trading.position;
                const pr = DM.price;
                const diff = p.side==='LONG' ? pr - p.entry : p.entry - pr;
                p.pnl = diff * 1000; // Sim size

                // Exit Logic
                let reason = null;
                if(p.side==='LONG') {
                    if(pr <= p.sl) reason = 'SL Hit';
                    if(pr >= p.tp) reason = 'TP Hit';
                    if(signal === 'SELL') reason = 'Signal Flip';
                } else {
                    if(pr >= p.sl) reason = 'SL Hit';
                    if(pr <= p.tp) reason = 'TP Hit';
                    if(signal === 'BUY') reason = 'Signal Flip';
                }

                if(reason) {
                    DM.trading.pnl += p.pnl;
                    Utils.log(`CLOSE ${p.side}: ${reason} ($${p.pnl.toFixed(2)})`, p.pnl>0?'buy':'sell');
                    DM.trading.position = null;
                }
            }
        };

        // ==========================================
        // 7. UI & WEBSOCKET
        // ==========================================
        function saveSettings() {
            const key = document.getElementById('api-key-input').value;
            if(key) {
                CONFIG.apiKey = key;
                localStorage.setItem('GEMINI_KEY', key);
                document.getElementById('settings-modal').classList.add('hidden-modal');
                Utils.toast("API Key Saved", "green");
            }
        }

        // DOM Render Loop
        const render = () => {
            if(DM.price) {
                // Ticker
                document.getElementById('ticker-price').textContent = Utils.formatCurrency(DM.price);
                
                // Indicators
                document.getElementById('ind-rsi').textContent = DM.indicators.rsi.toFixed(1);
                document.getElementById('ind-fisher').textContent = DM.indicators.fisher?.toFixed(2) || '0.00';
                document.getElementById('ind-adx').textContent = DM.indicators.adx.toFixed(0);
                document.getElementById('ind-st').textContent = DM.indicators.st?.dir === 1 ? 'BULL' : 'BEAR';
                document.getElementById('ind-st').className = `text-sm font-mono font-bold ${DM.indicators.st?.dir===1?'text-green-glow':'text-red-glow'}`;
                
                // WSS
                const wss = DM.wss || {score:0, action:'WAIT'};
                const sc = document.getElementById('wss-score');
                sc.textContent = wss.score.toFixed(1);
                sc.className = `text-6xl font-black orbitron ${wss.score>2?'text-green-glow':wss.score<-2?'text-red-glow':'text-gray-700'}`;
                document.getElementById('wss-action').textContent = wss.action;
                document.getElementById('wss-reasons').textContent = wss.reasons;

                // Orderbook
                const renderBook = (m, el, type) => {
                    const arr = Array.from(m).sort((a,b) => type==='ask'?a[0]-b[0]:b[0]-a[0]).slice(0,12);
                    if(type==='ask') arr.reverse();
                    const max = Math.max(...arr.map(x=>x[1]), 0.1);
                    el.innerHTML = arr.map(([p,q]) => `
                        <div class="ob-row mono">
                            <span class="${type==='ask'?'text-red-glow':'text-green-glow'}">${p.toFixed(1)}</span>
                            <span class="text-center text-gray-500">${q.toFixed(3)}</span>
                            <span class="text-right text-gray-600">${(p*q/1000).toFixed(0)}K</span>
                            <div class="ob-bg ${type==='ask'?'bg-ask':'bg-bid'}" style="width:${(q/max)*100}%"></div>
                        </div>
                    `).join('');
                };
                renderBook(DM.asks, document.getElementById('ob-asks'), 'ask');
                renderBook(DM.bids, document.getElementById('ob-bids'), 'bid');
                
                // Imbalance & Spread
                const spread = Math.abs((Array.from(DM.asks.keys())[0]||0) - (Array.from(DM.bids.keys())[0]||0));
                document.getElementById('ob-spread').textContent = spread.toFixed(1);
                document.getElementById('imbalance-bar').style.width = `${DM.imbalance*100}%`;
                document.getElementById('imbalance-pct').textContent = `${(DM.imbalance*100).toFixed(0)}%`;

                // Position
                const p = DM.trading.position;
                if(p) {
                    document.getElementById('pos-idle').classList.add('hidden');
                    document.getElementById('pos-active').classList.remove('hidden');
                    document.getElementById('pos-side').textContent = p.side;
                    document.getElementById('pos-side').className = `text-base font-black px-2 py-1 rounded ${p.side==='LONG'?'bg-green-900 text-green-300':'bg-red-900 text-red-300'}`;
                    document.getElementById('pos-pnl').textContent = p.pnl.toFixed(2);
                    document.getElementById('pos-pnl').className = `text-2xl font-bold orbitron ${p.pnl>0?'text-green-glow':'text-red-glow'}`;
                    document.getElementById('pos-entry').textContent = p.entry.toFixed(2);
                    document.getElementById('pos-sl').textContent = p.sl.toFixed(2);
                    document.getElementById('pos-tp').textContent = p.tp.toFixed(2);
                } else {
                    document.getElementById('pos-idle').classList.remove('hidden');
                    document.getElementById('pos-active').classList.add('hidden');
                }
                
                // Header PnL
                document.getElementById('header-pnl').textContent = Utils.formatCurrency(DM.trading.pnl);
            }
            requestAnimationFrame(render);
        };

        // WebSocket Setup
        const startWS = () => {
            const ws = new WebSocket(CONFIG.wsUrl);
            let ping;
            ws.onopen = () => {
                document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#00ff00]';
                ws.send(JSON.stringify({op: 'subscribe', args: ['orderbook.50.BTCUSDT', 'kline.1.BTCUSDT']}));
                ping = setInterval(() => ws.readyState===1 && ws.send(JSON.stringify({op:'ping'})), 20000);
            };
            ws.onmessage = (e) => {
                const m = JSON.parse(e.data);
                if(m.ts) document.getElementById('latency').textContent = `${Date.now()-parseInt(m.ts)}ms LAG`;
                if(m.topic?.includes('kline')) DM.updateCandle(m.data[0]);
                if(m.topic?.includes('orderbook')) DM.updateBook(m);
            };
            ws.onclose = () => {
                document.getElementById('status-dot').className = 'w-3 h-3 rounded-full bg-red-500';
                clearInterval(ping);
                setTimeout(startWS, 3000);
            };
        };

        // Boot
        document.getElementById('api-key-input').value = CONFIG.apiKey;
        startWS();
        render();

    </script>
</body>
</html>
