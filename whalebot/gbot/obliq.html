<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON PRO | Liquidity Hunter</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-core: #030303;
            --bg-panel: rgba(12, 12, 12, 0.95);
            --bg-accent: #111;
            
            --neon-cyan: #00f3ff;
            --neon-green: #0aff0a;
            --neon-red: #ff003c;
            --neon-yellow: #fcee0a;
            --neon-purple: #bc13fe;
            
            --text-main: #e0e0e0;
            --text-muted: #666;
            
            --font-mono: 'Courier New', Courier, monospace;
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-core);
            /* Cyberpunk Grid Background */
            background-image: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%;
            color: var(--text-main);
            font-family: var(--font-mono);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 55px;
            border-bottom: 1px solid #222;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            background: rgba(5,5,5,0.95);
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.05);
            z-index: 100;
        }

        .brand {
            font-size: 1.2rem; font-weight: 800; letter-spacing: 2px;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            display: flex; align-items: center; gap: 12px;
        }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #333; transition: 0.3s;
        }
        .status-dot.active { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }
        .status-dot.error { background: var(--neon-red); box-shadow: 0 0 8px var(--neon-red); }

        .controls { display: flex; gap: 10px; }

        /* Inputs */
        input, select, button {
            background: #080808; border: 1px solid #333;
            color: var(--neon-cyan); padding: 6px 10px;
            font-family: inherit; font-size: 0.8rem; font-weight: bold;
            text-transform: uppercase; transition: 0.2s var(--ease);
        }
        input:focus, select:focus { border-color: var(--neon-cyan); box-shadow: 0 0 8px rgba(0,243,255,0.2); }
        button { cursor: pointer; letter-spacing: 1px; }
        button:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 15px var(--neon-cyan); }

        /* --- LAYOUT GRID --- */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            height: calc(100vh - 55px);
            position: relative;
        }

        /* --- LEFT: CHART --- */
        #chart-wrapper {
            position: relative; border-right: 1px solid #222;
            width: 100%; height: 100%;
        }
        #chart-container { width: 100%; height: 100%; }
        
        .loader {
            position: absolute; top:50%; left:50%; transform: translate(-50%, -50%);
            color: var(--neon-cyan); font-size: 1rem; letter-spacing: 3px;
            display: none; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        /* --- RIGHT: SIDEBAR --- */
        .sidebar {
            background: var(--bg-panel);
            display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
        }

        /* Module: Price & Stats */
        .price-panel {
            padding: 20px; border-bottom: 1px solid #222;
            text-align: center;
        }
        .current-price {
            font-size: 2.2rem; font-weight: 900; letter-spacing: 1px;
            margin: 10px 0; transition: color 0.2s;
        }
        .text-up { color: var(--neon-green); text-shadow: 0 0 15px rgba(10,255,10,0.2); }
        .text-down { color: var(--neon-red); text-shadow: 0 0 15px rgba(255,0,60,0.2); }

        .threshold-control {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; color: var(--text-muted);
            margin-top: 10px; background: #050505; padding: 5px 10px; border-radius: 4px;
        }

        /* Module: Signals */
        .signals-panel {
            flex: 0 0 200px; /* Fixed height */
            border-bottom: 1px solid #222;
            display: flex; flex-direction: column;
            background: #080808;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 8px 12px; font-size: 0.7rem; color: var(--neon-purple);
            border-bottom: 1px solid #222; letter-spacing: 1px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(90deg, rgba(188,19,254,0.1), transparent);
        }

        .signals-list {
            flex: 1; overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .signals-list::-webkit-scrollbar { width: 4px; }
        .signals-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .signal-card {
            background: rgba(255,255,255,0.03);
            border-left: 3px solid #555;
            padding: 8px 10px;
            animation: slideIn 0.4s var(--ease);
            position: relative;
        }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .sig-long { border-color: var(--neon-green); box-shadow: inset 10px 0 20px -10px rgba(10,255,10,0.1); }
        .sig-short { border-color: var(--neon-red); box-shadow: inset 10px 0 20px -10px rgba(255,0,60,0.1); }

        .sig-title { font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .sig-info { font-size: 0.7rem; color: #888; display: flex; justify-content: space-between; }
        .sig-val { color: var(--neon-yellow); }

        /* Module: Orderbook */
        .ob-panel {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
        }
        .ob-header-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            padding: 6px 15px; font-size: 0.7rem; color: #555;
            border-bottom: 1px solid #222;
        }
        .col-right { text-align: right; }

        .ob-scroll { flex: 1; overflow-y: auto; position: relative; }
        .ob-scroll::-webkit-scrollbar { width: 4px; }
        .ob-scroll::-webkit-scrollbar-thumb { background: #333; }

        .ob-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .ob-table td { padding: 3px 15px; text-align: right; font-variant-numeric: tabular-nums; }
        .ob-table td:first-child { text-align: left; font-weight: bold; }
        
        .row-ask td { color: var(--neon-red); }
        .row-bid td { color: var(--neon-green); }
        
        /* Flash Animation for new significant levels */
        .flash-ask { animation: flashR 0.8s; }
        .flash-bid { animation: flashG 0.8s; }
        @keyframes flashR { 0% { background: rgba(255,0,60,0.4); } 100% { background: transparent; } }
        @keyframes flashG { 0% { background: rgba(10,255,10,0.4); } 100% { background: transparent; } }

        .val-cell { color: var(--neon-yellow); font-size: 0.7rem; opacity: 0.8; }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <div id="statusLed" class="status-dot"></div>
        <span>NEON<span style="color:#fff">PRO</span></span>
    </div>
    <div class="controls">
        <input type="text" id="symbolInput" value="BTCUSDT" style="width: 100px;">
        <select id="intervalInput">
            <option value="1">1m</option>
            <option value="5">5m</option>
            <option value="15">15m</option>
            <option value="60">1h</option>
            <option value="240">4h</option>
        </select>
        <button id="connectBtn">CONNECT</button>
    </div>
</header>

<div class="grid-container">
    <!-- Chart Section -->
    <div id="chart-wrapper">
        <div id="chart-container"></div>
        <div id="loader" class="loader">INITIALIZING DATA STREAM...</div>
    </div>

    <!-- Sidebar Section -->
    <div class="sidebar">
        <!-- Price -->
        <div class="price-panel">
            <div style="font-size:0.75rem; color:#666; letter-spacing:2px;">MARKET PRICE</div>
            <div id="priceDisplay" class="current-price">---</div>
            
            <div class="threshold-control">
                <span>LIQ. THRESHOLD ($)</span>
                <input type="number" id="thresholdInput" value="250000" step="10000" style="width:90px; text-align:right; border:none; background:#111;">
            </div>
        </div>

        <!-- Signals -->
        <div class="signals-panel">
            <div class="panel-header">
                <span>âš¡ LIQUIDATION SIGNALS</span>
                <span id="signalCount" style="background:#222; padding:1px 5px; border-radius:4px;">0</span>
            </div>
            <div id="signalsList" class="signals-list">
                <div style="text-align:center; padding:20px; color:#333; font-size:0.8rem;">Scanning Orderflow...</div>
            </div>
        </div>

        <!-- Orderbook -->
        <div class="ob-panel">
            <div class="ob-header-row">
                <span>PRICE</span>
                <span class="col-right">SIZE</span>
                <span class="col-right">VALUE ($)</span>
            </div>
            
            <!-- Asks (Resistance) -->
            <div class="ob-scroll" style="border-bottom:1px solid #222; display:flex; flex-direction:column-reverse;">
                <table class="ob-table"><tbody id="asksBody"></tbody></table>
            </div>

            <!-- Bids (Support) -->
            <div class="ob-scroll">
                <table class="ob-table"><tbody id="bidsBody"></tbody></table>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * NEON PRO TERMINAL
 * Integrates: Lightweight Charts, Bybit V5 Socket, Liquidity Logic
 */

class App {
    constructor() {
        // State
        this.symbol = 'BTCUSDT';
        this.interval = '1';
        this.threshold = 250000;
        this.lastPrice = 0;
        
        // Data
        this.bids = {}; 
        this.asks = {}; 
        this.history = []; // Price history for trend calculation
        this.signals = [];
        
        // Modules
        this.chart = null;
        this.candleSeries = null;
        this.ws = null;
        this.renderPending = false;
        
        // DOM Elements
        this.dom = {
            price: document.getElementById('priceDisplay'),
            bids: document.getElementById('bidsBody'),
            asks: document.getElementById('asksBody'),
            signals: document.getElementById('signalsList'),
            count: document.getElementById('signalCount'),
            led: document.getElementById('statusLed'),
            loader: document.getElementById('loader')
        };
        
        this.initChart();
        this.bindEvents();
        this.start();
    }

    // --- CHART SETUP ---
    initChart() {
        const container = document.getElementById('chart-container');
        this.chart = LightweightCharts.createChart(container, {
            layout: { background: { type: 'solid', color: '#030303' }, textColor: '#666' },
            grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: '#222' },
            timeScale: { borderColor: '#222', timeVisible: true }
        });

        this.candleSeries = this.chart.addCandlestickSeries({
            upColor: '#0aff0a', downColor: '#ff003c',
            borderVisible: false, wickUpColor: '#0aff0a', wickDownColor: '#ff003c'
        });

        new ResizeObserver(entries => {
            if(entries.length) {
                const {width, height} = entries[0].contentRect;
                this.chart.applyOptions({ width, height });
            }
        }).observe(container);
    }

    bindEvents() {
        document.getElementById('connectBtn').onclick = () => this.start();
        document.getElementById('thresholdInput').oninput = (e) => {
            this.threshold = parseFloat(e.target.value) || 0;
            this.requestUpdate();
        };
    }

    // --- CORE LOGIC ---
    async start() {
        // Get Inputs
        this.symbol = document.getElementById('symbolInput').value.toUpperCase();
        this.interval = document.getElementById('intervalInput').value;
        
        // UI Reset
        this.dom.loader.style.display = 'block';
        this.dom.led.className = 'status-dot';
        if(this.ws) this.ws.close();
        
        // Data Reset
        this.bids = {}; this.asks = {}; this.signals = [];
        this.dom.bids.innerHTML = ''; this.dom.asks.innerHTML = '';
        this.dom.signals.innerHTML = '<div style="text-align:center; padding:20px; color:#333; font-size:0.8rem;">Scanning Orderflow...</div>';
        
        // 1. Fetch History (REST)
        await this.loadHistory();
        
        // 2. Connect (WS)
        this.connectWS();
    }

    async loadHistory() {
        try {
            const url = `https://api.bybit.com/v5/market/kline?category=linear&symbol=${this.symbol}&interval=${this.interval}&limit=200`;
            const res = await fetch(url);
            const data = await res.json();
            
            if(data.retCode === 0) {
                const candles = data.result.list.map(x => ({
                    time: parseInt(x[0])/1000,
                    open: parseFloat(x[1]), high: parseFloat(x[2]),
                    low: parseFloat(x[3]), close: parseFloat(x[4])
                })).sort((a,b) => a.time - b.time);
                
                this.candleSeries.setData(candles);
                if(candles.length) this.updatePrice(candles[candles.length-1].close);
                
                this.history = candles.map(c => c.close); // Seed history
            }
        } catch(e) { console.error(e); }
        finally { this.dom.loader.style.display = 'none'; }
    }

    connectWS() {
        this.ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
        
        this.ws.onopen = () => {
            this.dom.led.classList.add('active');
            // Keep alive
            this.pingInt = setInterval(() => { if(this.ws.readyState===1) this.ws.send(JSON.stringify({op:'ping'})); }, 20000);
            
            // Sub
            const args = [
                `tickers.${this.symbol}`,
                `orderbook.200.${this.symbol}`,
                `kline.${this.interval}.${this.symbol}`
            ];
            this.ws.send(JSON.stringify({op:'subscribe', args}));
        };

        this.ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            const topic = msg.topic || '';

            if(topic.startsWith('tickers')) {
                const p = msg.data[0].lastPrice;
                if(p) this.updatePrice(p);
            }
            else if(topic.startsWith('kline')) {
                const k = msg.data[0];
                this.candleSeries.update({
                    time: parseInt(k.start)/1000,
                    open: parseFloat(k.open), high: parseFloat(k.high),
                    low: parseFloat(k.low), close: parseFloat(k.close)
                });
            }
            else if(topic.startsWith('orderbook')) {
                this.handleOrderBook(msg);
            }
        };

        this.ws.onclose = () => {
            this.dom.led.classList.remove('active');
            this.dom.led.classList.add('error');
            clearInterval(this.pingInt);
        };
    }

    updatePrice(p) {
        const price = parseFloat(p);
        if(!price) return;
        
        const el = this.dom.price;
        el.innerText = price.toFixed(2);
        el.className = `current-price ${price >= this.lastPrice ? 'text-up' : 'text-down'}`;
        
        this.lastPrice = price;
        this.history.push(price);
        if(this.history.length > 50) this.history.shift();
    }

    handleOrderBook(msg) {
        const { type, data } = msg;
        const isSnap = type === 'snapshot';

        // Helper to update dict
        const update = (target, list) => {
            list.forEach(x => {
                const p = parseFloat(x[0]);
                const s = parseFloat(x[1]);
                if(s === 0) delete target[p];
                else target[p] = s;
            });
        };

        if(isSnap) {
            this.bids = {}; this.asks = {};
            data.b.forEach(x => this.bids[parseFloat(x[0])] = parseFloat(x[1]));
            data.a.forEach(x => this.asks[parseFloat(x[0])] = parseFloat(x[1]));
        } else {
            update(this.bids, data.b);
            update(this.asks, data.a);
        }

        this.requestUpdate();
    }

    requestUpdate() {
        if(!this.renderPending) {
            this.renderPending = true;
            requestAnimationFrame(() => {
                this.renderTables();
                this.scanSignals();
                this.renderPending = false;
            });
        }
    }

    // --- RENDERING & SIGNALS ---
    renderTables() {
        const fmt = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits:0 });
        
        const process = (src, isAsk) => {
            // Convert to Array -> Filter > Threshold -> Sort -> Top 20
            return Object.entries(src)
                .map(([p, s]) => ({ p: parseFloat(p), s, v: parseFloat(p)*s }))
                .filter(i => i.v >= this.threshold)
                .sort((a,b) => isAsk ? a.p - b.p : b.p - a.p) // Asks Asc, Bids Desc
                .slice(0, 20);
        };

        const askRows = process(this.asks, true);
        const bidRows = process(this.bids, false);

        const html = (rows, type) => rows.map(r => `
            <tr class="${type === 'ask' ? 'row-ask flash-ask' : 'row-bid flash-bid'}">
                <td>${r.p.toFixed(2)}</td>
                <td>${r.s.toFixed(3)}</td>
                <td class="val-cell">${fmt.format(r.v)}</td>
            </tr>
        `).join('');

        this.dom.asks.innerHTML = html(askRows, 'ask');
        this.dom.bids.innerHTML = html(bidRows, 'bid');
    }

    scanSignals() {
        if(!this.lastPrice || this.history.length < 10) return;

        // 1. Identify Largest Wall in Top 20 Levels
        const getWall = (src) => {
            let max = { v: 0, p: 0 };
            for(let p in src) {
                const val = parseFloat(p) * src[p];
                if(val > this.threshold * 1.5 && val > max.v) max = { v: val, p: parseFloat(p) };
            }
            return max.v > 0 ? max : null;
        };

        const bidWall = getWall(this.bids);
        const askWall = getWall(this.asks);
        const currentSignals = [];

        // 2. Logic: Price approaching huge wall + Momentum
        
        // LONG SIGNAL: Price drops near Bid Wall
        if(bidWall) {
            const dist = (this.lastPrice - bidWall.p) / this.lastPrice * 100;
            if(dist > 0 && dist < 1.5) {
                currentSignals.push({
                    type: 'LONG', wall: bidWall.p, val: bidWall.v, 
                    tp: this.lastPrice * 1.015
                });
            }
        }

        // SHORT SIGNAL: Price rises near Ask Wall
        if(askWall) {
            const dist = (askWall.p - this.lastPrice) / this.lastPrice * 100;
            if(dist > 0 && dist < 1.5) {
                currentSignals.push({
                    type: 'SHORT', wall: askWall.p, val: askWall.v,
                    tp: this.lastPrice * 0.985
                });
            }
        }

        // 3. Update Signal List (Debounced)
        if(currentSignals.length > 0) {
            const newSig = currentSignals[0];
            // Only add if different from top signal
            const top = this.signals[0];
            if(!top || top.type !== newSig.type || Math.abs(top.wall - newSig.wall) > top.wall*0.001) {
                this.signals.unshift(newSig);
                if(this.signals.length > 20) this.signals.pop();
                this.renderSignalsList();
            }
        }
    }

    renderSignalsList() {
        const fmt = new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 });
        this.dom.count.innerText = this.signals.length;
        
        this.dom.signals.innerHTML = this.signals.map(s => `
            <div class="signal-card ${s.type === 'LONG' ? 'sig-long' : 'sig-short'}">
                <div class="sig-title">
                    <span style="color:${s.type === 'LONG' ? '#0aff0a' : '#ff003c'}">${s.type}</span>
                    <span>@ ${s.wall.toFixed(2)}</span>
                </div>
                <div class="sig-info">
                    <span class="sig-val">Vol: $${fmt.format(s.val)}</span>
                    <span>TP: ${s.tp.toFixed(2)}</span>
                </div>
            </div>
        `).join('');
    }
}

// Boot
const app = new App();

</script>
</body>
</html>